Fix TTY inheritance, prompt formatting, file paths, and Codex sandbox permissions

Fixed "Error: 'i'" and file creation failures by escaping literal braces in
prompts, ensuring subprocess inherits TTY, providing absolute paths, and
enabling Codex write permissions via sandbox mode.

Root Cause Analysis:

The issues had FOUR root causes:

1. **Primary**: Prompt template formatting error
   - pattern_designer_structured.md contained `{i}` (lines 57, 88)
   - Python's str.format() tried to substitute `{i}` as a placeholder
   - Raised KeyError('i') when no value provided for 'i'
   - Exception handler printed: "Error: 'i'"

2. **Secondary**: Missing TTY inheritance
   - pattern_designer.py and aggregator.py used subprocess.run(cmd) without TTY
   - Even when run from real terminal, subprocess didn't have TTY access
   - Would have caused "stdout is not a terminal" error once template was fixed

3. **Tertiary**: Relative file paths in prompts
   - Prompts told agent to create files at "processed/rubric.md"
   - Agent created files relative to Codex's working directory
   - Files were created in wrong location, causing rubric validation to fail

4. **Quaternary**: Codex sandbox permissions
   - Codex runs in read-only sandbox mode by default
   - Agent claimed to create files but couldn't due to lack of write permissions
   - Files appeared created to agent but didn't exist on disk
   - Required --sandbox workspace-write flag for file creation

Changes Made:

* src/prompts/pattern_designer_structured.md:
  - Line 57, 88: Changed `{i}` to `{{i}}` to escape literal braces
  - Line 88: Changed `processed/activities/A{{i}}_criteria.md` to `{processed_dir}/activities/A{{i}}_criteria.md`
  - Line 92: Changed `processed/rubric.md` to `{processed_dir}/rubric.md`
  - Effect: Template uses absolute paths provided by Python wrapper

* src/prompts/pattern_designer_freeform.md:
  - Line 99: Changed `processed/marking_criteria.md` to `{processed_dir}/marking_criteria.md`
  - Line 103: Changed `processed/rubric.md` to `{processed_dir}/rubric.md`
  - Effect: Template uses absolute paths provided by Python wrapper

* src/agents/pattern_designer.py:
  - Line 92: Added `processed_dir=args.processed_dir` to format() call
  - Line 131: Added `stdin=sys.stdin, stdout=sys.stdout, stderr=sys.stderr` to subprocess.run()
  - Effect: Passes absolute processed directory path to template and inherits TTY

* src/agents/aggregator.py:
  - Line 157: Added `stdin=sys.stdin, stdout=sys.stdout, stderr=sys.stderr` to subprocess.run()
  - Effect: Interactive CLI inherits parent's TTY for proper terminal access

* src/llm_caller.sh:
  - Claude: Replaced script with tee for session capture (works in all contexts)
  - Gemini: Replaced script with tee for session capture (works in all contexts)
  - Codex interactive: Added --sandbox workspace-write flag (lines 165, 168)
    • Enables file creation within workspace directory tree
    • Prevents read-only sandbox limitation
    • Allows agent to actually create files, not just claim to
  - Codex: Special TTY handling
    • Interactive mode: Runs directly without output capture
    • Saves only session start/end timestamps
    • Allows TTY passthrough for interactive use

* README.md:
  - Added note about Codex TTY requirements
  - Documented limitations for interactive vs headless modes
  - Added blank lines around lists for markdown linting

Codex Sandbox Modes:

Codex CLI has three sandbox modes (controlled via --sandbox flag):

1. **read-only** (default):
   - Prevents all file modifications
   - Agent can read files but not create/modify them
   - Safest mode but breaks file-creation workflows

2. **workspace-write**:
   - Allows writing within current workspace directory tree
   - Agent can create/modify files in project directories
   - Appropriate for Pattern Designer and other file-creating agents

3. **danger-full-access**:
   - Full filesystem access (dangerous)
   - Not recommended for normal use
   - Only for specific advanced scenarios

For interactive agents that need to create files (Pattern Designer, Aggregator),
we use `--sandbox workspace-write` to enable file creation while maintaining
reasonable security boundaries.

Python String Formatting Gotcha:

When using str.format() or f-strings, literal braces must be doubled:
- `"A{i}"` → tries to substitute variable `i`
- `"A{{i}}"` → renders as literal `A{i}`

This affects:
- Template strings with placeholders AND literal braces
- Format strings that need to output curly braces
- Any code using .format() or f-strings with mixed content

File Path Best Practices:

When instructing LLM agents to create files:
- ✓ Use absolute paths: `/full/path/to/file.md`
- ✗ Use relative paths: `processed/file.md`

Relative paths are resolved from agent's current working directory, which may be:
- User's home directory
- System temp directory
- LLM CLI's installation directory
- Anywhere else depending on how the CLI was invoked

Absolute paths ensure files are created in the correct location regardless of
the agent's working directory.

How subprocess TTY Inheritance Works:

By default, subprocess.run(cmd) creates new pipes for stdin/stdout/stderr:
- Parent's TTY: /dev/ttys001 (or similar)
- Subprocess stdin: pipe (not a TTY)
- Subprocess stdout: pipe (not a TTY)
- Result: isatty() returns False in subprocess

With stdin=sys.stdin, stdout=sys.stdout, stderr=sys.stderr:
- Parent's TTY: /dev/ttys001
- Subprocess stdin: /dev/ttys001 (inherited)
- Subprocess stdout: /dev/ttys001 (inherited)
- Result: isatty() returns True in subprocess

This allows interactive CLIs (Codex, Claude, Gemini) to:
- Detect they're running in a terminal
- Enable interactive features (prompts, colors, etc.)
- Properly handle user input

Agent Types and Requirements:

Interactive Agents (need TTY + write permissions):
- Pattern Designer: Creates rubric and marking criteria with instructor
  • Needs: TTY for interaction, workspace-write for file creation
- Aggregator: Compiles final grades and statistics
  • Needs: TTY for interaction, workspace-write for CSV creation
- Now properly inherit TTY and have write permissions

Headless Agents (don't need TTY, use capture):
- Marker: Evaluates student work (uses capture_output=True)
- Normalizer: Aggregates assessments (uses capture_output=True)
- Unifier: Applies final scheme (uses capture_output=True)
- Already working correctly with output capture

Testing:

Before fix:
✗ ./mark_structured.sh → "Error: 'i'" from KeyError in template formatting
✗ Even after template fix → "Error: stdout is not a terminal"
✗ Even after TTY fix → Files created in wrong directory
✗ Even after path fix → Agent claims files created but they don't exist (read-only sandbox)

After fix:
✓ ./mark_structured.sh → Pattern Designer launches interactively
✓ Template renders correctly with A{i} literal braces
✓ Codex detects TTY and runs in interactive mode
✓ Codex has write permissions via --sandbox workspace-write
✓ Files created at correct absolute paths
✓ Files actually exist on disk after agent completes
✓ Rubric validation succeeds
✓ Claude and Gemini work with tee-based session capture
✓ All headless agents continue working with output capture

Provider-Specific Behavior:

Claude Code CLI:
- Interactive: Accepts piped input via stdin
- Session capture: Full capture via tee
- TTY requirement: Not strict (works with or without)
- File access: Uses built-in Write tool (no special sandbox config needed)

Gemini CLI:
- Interactive: Accepts piped input via stdin
- Session capture: Full capture via tee
- TTY requirement: Not strict (works with or without)
- File access: Uses built-in tools (configuration may vary)

Codex CLI:
- Interactive: Requires real TTY (strict isatty() check)
- Session capture: Limited to timestamps only
- TTY requirement: Strict (fails without TTY)
- File access: Requires --sandbox workspace-write for file creation
- Default: read-only sandbox prevents file modifications

User Impact:

Before: Users saw cryptic "Error: 'i'" and files weren't created
After: Users can successfully run interactive agents and files are created correctly

The fix ensures that:
1. Prompt templates format correctly without KeyError
2. When instructors run ./mark_structured.sh from terminal, it works
3. Interactive agents can properly interact with the user
4. Codex has necessary write permissions to create files
5. Files are created at the correct absolute paths
6. Files actually exist on disk (not just claimed by agent)
7. Rubric validation succeeds after pattern design
8. Session logs are captured (fully for Claude/Gemini, timestamps for Codex)
9. Headless agents continue working in parallel execution

Files Changed:
- src/prompts/pattern_designer_structured.md (template escaping + absolute paths)
- src/prompts/pattern_designer_freeform.md (absolute paths)
- src/agents/pattern_designer.py (TTY inheritance + pass processed_dir to template)
- src/agents/aggregator.py (TTY inheritance)
- src/llm_caller.sh (session capture with tee/TTY handling + Codex sandbox mode)
- README.md (documentation and linting)
